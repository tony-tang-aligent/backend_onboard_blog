services:
  php:
    image: aligent/magento2-local:2.4.7
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      - db
      - mail
    volumes:
      - ./src:/var/www/html
      - ~/.composer/cache:/.composer/cache
      - ~/.composer/auth.json:/.composer/auth.json
    environment:
      - COMPOSER_AUTH=${COMPOSER_AUTH}
      - COMPOSER_HOME=/.composer

  php-debug:
    image: aligent/magento2-local:2.4.7-debug
    user: "${UID:-1000}:${GID:-1000}"
    depends_on:
      - php
    volumes:
      - ./src:/var/www/html
      - ~/.composer/cache:/.composer/cache
      - ~/.composer/auth.json:/.composer/auth.json
    environment:
      - COMPOSER_AUTH=${COMPOSER_AUTH}
      - COMPOSER_HOME=/.composer
    extra_hosts:
      - host.docker.internal:host-gateway

  web:
    image: nginx
    depends_on:
      - php
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./src:/var/www/html
    networks:
      - default
      - dev-gateway
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-web.rule=HostRegexp(`${COMPOSE_PROJECT_NAME}.aligent.dev`, `{{[a-zA-Z0-9_]+}-${COMPOSE_PROJECT_NAME}}.aligent.dev`, `{${COMPOSE_PROJECT_NAME}-{[a-zA-Z0-9_]+}}.aligent.dev`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-web.priority=1"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-web.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-web.tls=true"

  db:
    image: mariadb:10.6
      environment:
        - MARIADB_ROOT_PASSWORD=magento2
        - MARIADB_USER=magento2
        - MARIADB_PASSWORD=magento2
        - MARIADB_DATABASE=magento2
      volumes:
        - db-data:/var/lib/mysql
        - ./docker/db:/docker-entrypoint-initdb.d
      networks:
        - default


  mail:
    image: axllent/mailpit:v1.10
    networks:
      - default
      - dev-gateway
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-mail.rule=Host(`mail-${COMPOSE_PROJECT_NAME}.aligent.dev`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-mail.entrypoints=websecure"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME}-mail.loadBalancer.server.port=8025"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-mail.tls=true"

volumes:
  db-data:

networks:
  default:
    name: ${COMPOSE_PROJECT_NAME}-dev

  dev-gateway:
    external: true
